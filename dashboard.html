<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ArrhythME-AI</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #ca7e7e;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 800px;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #a00e0e;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
        }
        .user-info {
            font-weight: bold;
            color: #a00e0e;
        }

        .dashboard-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
        }
        .dashboard-nav button {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 12px 20px;
            background: #a00e0e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .dashboard-nav button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }
        .dashboard-nav button.active {
            background: #a00e0e;
            box-shadow: 0 0 0 3px rgba(144, 11, 11, 0.4);
        }

        .dashboard-content {
            background: white;
            width: 100%;
            max-width: 800px;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: left;
            margin-top: 20px;
            min-height: 300px;
        }
        .dashboard-content h3 {
            color: #a00e0e;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        #profile-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        #profile-section input[type="text"],
        #profile-section input[type="email"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        #profile-section button {
            background: #a00e0e;
            margin-top: 10px;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #profile-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        #heart-rate-section .heart-rate-display {
            font-size: 4em;
            font-weight: bold;
            color: #e53935;
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        #heart-rate-section p {
            text-align: center;
        }
        #heart-rate-section button {
            background: #a00e0e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }
        #heart-rate-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        /* Heart Rate List for Doctors */
        #heart-rate-section #patient-bpm-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background-color: #fcfcfc;
        }
        #heart-rate-section #patient-bpm-list li {
            background-color: #f5f5f5;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        #heart-rate-section #patient-bpm-list li strong {
            color: #333;
        }
        #heart-rate-section #patient-bpm-list li span {
            color: #e53935;
            font-weight: bold;
        }


        #education-section ul {
            list-style: none;
            padding: 0;
        }

        #education-section li {
            background-color: #f5f5f5;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        #education-section li:hover {
            transform: translateY(-3px);
        }

        #education-section h4 {
            color: #a00e0e;
            margin-bottom: 5px;
            font-size: 1.3em;
        }

        #education-section p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.5;
            text-align: left;
        }
        /* Tambahan untuk link artikel */
        #education-section .article-link {
            display: block;
            margin-top: 10px;
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        #education-section .article-link:hover {
            text-decoration: underline;
        }

        #education-section button {
            margin-top: 20px;
            width: 100%;
            background: #a00e0e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #education-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        /* Chat Section Styling */
        #chat-section .chat-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
        }
        #chat-section .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 0.95em;
        }
        #chat-section .message.user { /* Pesan dari user yang sedang login (baik pasien/dokter) */
            background-color: #e1ffc7;
            align-self: flex-end;
            margin-left: auto;
        }
        #chat-section .message.doctor-reply { /* Pesan dari dokter lain (untuk pasien) atau dari diri sendiri (untuk dokter) */
            background-color: #d1e7dd;
            align-self: flex-start;
            margin-right: auto;
        }
        #chat-section .message.patient-other { /* Pesan dari pasien lain (untuk tampilan dokter) */
            background-color: #f0f8ff;
            align-self: flex-start;
            margin-right: auto;
        }
        #chat-section .chat-input {
            display: flex;
            gap: 10px;
        }
        #chat-section .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        #chat-section .chat-input button {
            padding: 10px 15px;
            margin-top: 0;
            background: #a00e0e;
            color: white;
            border-radius: 5px;
            font-size: 1em;
        }
        #chat-section .chat-input button:hover {
            background: #8e0c0c;
        }
        /* Styling untuk daftar pasien (khusus dokter) */
        #patient-list-container {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 180px; /* Batasi tinggi untuk scroll */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background-color: #fcfcfc;
        }

        #patient-list-container h4 {
            color: #a00e0e;
            margin-bottom: 15px;
            text-align: center;
        }

        #patient-list-container button {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #patient-list-container button:hover {
            background-color: #e0e0e0;
            border-color: #c0c0c0;
        }
        #patient-list-container button.active-patient {
            background-color: #d1e7dd; /* Highlight the selected patient */
            border-color: #a0c2a0;
            font-weight: bold;
        }
        /* Style untuk judul chat jika dokter sudah memilih pasien */
        #chat-section .chat-with-patient-title {
            text-align: center;
            font-size: 1.5em;
            color: #a00e0e;
            margin-bottom: 15px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Selamat Datang di Dashboard ArrhythME-AI!</h1>
        <p>Anda telah berhasil masuk.</p>
        <p>Email Anda: <span id="user-email" class="user-info">Memuat...</span></p>
        <p>Peran Anda: <span id="user-role" class="user-info">Memuat...</span></p>

        <p>Di sini Anda dapat memantau detak jantung, melihat riwayat analisis, dan mengelola pengaturan.</p>
        <p>Fitur-fitur canggih akan segera hadir!</p>

        <div class="dashboard-nav">
            <button id="nav-profile" class="active">Profil</button>
            <button id="nav-heart-rate">Detak Jantung (BPM)</button>
            <button id="nav-education">Edukasi</button>
            <button id="nav-chat">Chat dengan Dokter</button>
            <button id="logout-btn">Logout</button>
        </div>
    </div>

    <div class="dashboard-content">
        <div id="profile-section" class="content-section">
            <h3>Profil Pengguna</h3>
            <label for="profile-name">Nama:</label>
            <input type="text" id="profile-name" placeholder="Masukkan Nama Lengkap" disabled>
            <label for="profile-email">Email:</label>
            <input type="email" id="profile-email" value="user@example.com" disabled>
            <label for="profile-nik">NIK:</label>
            <input type="text" id="profile-nik" placeholder="Masukkan NIK Anda" disabled>
            <label for="profile-place-dob">Tempat, Tanggal Lahir:</label>
            <input type="text" id="profile-place-dob" placeholder="Contoh: Jakarta, 01/01/1990" disabled>
            <label for="profile-address">Alamat:</label>
            <input type="text" id="profile-address" placeholder="Masukkan Alamat Lengkap" disabled>
            <label for="profile-phone">Nomor Telepon:</label>
            <input type="text" id="profile-phone" placeholder="Masukkan Nomor Telepon" disabled>
            <button id="edit-profile-btn">Edit Profil</button>
            <button id="save-profile-btn" style="display: none;">Simpan Profil</button>
        </div>

        <div id="heart-rate-section" class="content-section" style="display: none;">
            <h3>Detak Jantung (BPM)</h3>
            <div class="heart-rate-display" id="current-bpm-display">-- BPM</div>
            <p id="bpm-status-message">Data detak jantung terbaru Anda akan ditampilkan di sini.</p>
            <button id="refresh-bpm-btn">Refresh BPM</button>

            <div id="doctor-bpm-view" style="display: none;">
                <h4>Daftar Detak Jantung Pasien:</h4>
                <ul id="patient-bpm-list">
                    </ul>
            </div>
        </div>

        <div id="education-section" class="content-section" style="display: none;">
            <h3>Pusat Edukasi Kesehatan Jantung</h3>
            <p>Dapatkan informasi terbaru mengenai kesehatan jantung, pencegahan, dan gaya hidup sehat.</p>
            <ul id="article-list">
                </ul>
            <button>Lihat Artikel Selengkapnya</button>
        </div>

        <div id="chat-section" class="content-section" style="display: none;">
            <h3>Chat dengan Dokter</h3>
            <div class="chat-box" id="chat-messages">
                </div>
            <div class="chat-input">
                <input type="text" id="chat-message-input" placeholder="Ketik pesan Anda...">
                <button id="send-chat-btn">Kirim</button>
            </div>
            <p style="font-size: 0.9em; color: #888; text-align: center; margin-top: 15px;">
                *Layanan ini untuk konsultasi awal. Untuk diagnosis, segera temui dokter.
            </p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        // Konfigurasi Firebase Anda (HARUS SESUAI DENGAN PROYEK FIREBASE ANDA)
        const firebaseConfig = {
            apiKey: "AIzaSyD8ROGRR-CvDaD3THjpFagbt-I0jFPoTEk",
            authDomain: "arrhythme-ai-29cc8.firebaseapp.com",
            projectId: "arrhythme-ai-29cc8",
            storageBucket: "arrhythme-ai-29cc8.firebasestorage.app",
            messagingSenderId: "869423405995",
            appId: "1:869423405995:web:d750c0530b9709029190ee"
            // databaseURL: "https://arrhythme-ai-29cc8-default-rtdb.firebaseio.com", // Hapus atau komentari ini jika menggunakan Firestore
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Dapatkan elemen DOM
        const userEmailSpan = document.getElementById('user-email');
        const userRoleSpan = document.getElementById('user-role');
        const logoutBtn = document.getElementById('logout-btn');

        // Navigasi
        const navProfileBtn = document.getElementById('nav-profile');
        const navHeartRateBtn = document.getElementById('nav-heart-rate');
        const navEducationBtn = document.getElementById('nav-education');
        const navChatBtn = document.getElementById('nav-chat');

        // Bagian Konten
        const profileSection = document.getElementById('profile-section');
        const heartRateSection = document.getElementById('heart-rate-section');
        const educationSection = document.getElementById('education-section');
        const chatSection = document.getElementById('chat-section');

        // Elemen Profil
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const profileNikInput = document.getElementById('profile-nik');
        const profilePlaceDobInput = document.getElementById('profile-place-dob');
        const profileAddressInput = document.getElementById('profile-address');
        const profilePhoneInput = document.getElementById('profile-phone');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        // Elemen Heart Rate
        const currentBpmDisplay = document.getElementById('current-bpm-display');
        const bpmStatusMessage = document.getElementById('bpm-status-message');
        const refreshBpmBtn = document.getElementById('refresh-bpm-btn');
        const doctorBpmView = document.getElementById('doctor-bpm-view');
        const patientBpmList = document.getElementById('patient-bpm-list');

        // Elemen Edukasi
        const articleList = document.getElementById('article-list');

        // Elemen Chat
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // Variabel global untuk peran dan chat dokter
        let currentUserRole = 'patient'; // Default role (akan di-overwrite dari Firestore)
        let selectedPatientIdForDoctor = null; // UID pasien yang sedang dilihat/dibalas dokter
        let selectedPatientNameForDoctor = ''; // Nama pasien yang sedang dilihat/dibalas dokter

        // Div untuk daftar pasien (hanya untuk dokter)
        const patientListDiv = document.createElement('div');
        patientListDiv.id = 'patient-list-container';
        chatSection.insertBefore(patientListDiv, chatMessagesDiv); // Sisipkan di awal chatSection

        // --- Fungsi Utama ---

        function showSection(sectionToShow) {
            const sections = [profileSection, heartRateSection, educationSection, chatSection];
            sections.forEach(section => {
                if (section === sectionToShow) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });

            const navButtons = document.querySelectorAll('.dashboard-nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            if (sectionToShow === profileSection) navProfileBtn.classList.add('active');
            else if (sectionToShow === heartRateSection) navHeartRateBtn.classList.add('active');
            else if (sectionToShow === educationSection) navEducationBtn.classList.add('active');
            else if (sectionToShow === chatSection) navChatBtn.classList.add('active');
        }

        // --- Firebase Auth & Profile Management ---

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User logged in:", user.email);
                userEmailSpan.textContent = user.email;
                profileEmailInput.value = user.email;

                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        console.log("User data loaded:", userData);
                        profileNameInput.value = userData.name || '';
                        profileNikInput.value = userData.nik || '';
                        profilePlaceDobInput.value = userData.placeDob || '';
                        profileAddressInput.value = userData.address || '';
                        profilePhoneInput.value = userData.phone || '';
                        currentUserRole = userData.role || 'patient'; // Pastikan role terbaca
                        userRoleSpan.textContent = currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1);

                        // --- Logika Pengalihan Dashboard Berdasarkan Peran ---
                        if (currentUserRole === 'doctor') {
                            // Dokter
                            showSection(chatSection); // Default ke Chat
                            navProfileBtn.style.display = 'none'; // Sembunyikan profil untuk dokter
                            navHeartRateBtn.style.display = 'inline-block'; // Tampilkan tombol detak jantung
                            navEducationBtn.style.display = 'none'; // Sembunyikan edukasi untuk dokter
                            navChatBtn.classList.add('active'); // Pastikan tombol chat aktif
                            patientListDiv.style.display = 'block'; // Tampilkan daftar pasien untuk dokter

                            doctorBpmView.style.display = 'block'; // Tampilkan bagian BPM pasien untuk dokter
                            refreshBpmBtn.style.display = 'none'; // Sembunyikan tombol refresh BPM untuk dokter
                            bpmStatusMessage.textContent = 'Data detak jantung semua pasien akan ditampilkan di sini.';
                            loadPatientBPMs(); // Muat data BPM pasien
                            loadPatientListForChat(); // Muat daftar pasien untuk chat
                        } else {
                            // Pasien
                            showSection(profileSection); // Default ke Profil untuk pasien
                            navProfileBtn.style.display = 'inline-block';
                            navHeartRateBtn.style.display = 'inline-block';
                            navEducationBtn.style.display = 'inline-block';
                            navChatBtn.style.display = 'inline-block';
                            patientListDiv.style.display = 'none'; // Sembunyikan daftar pasien untuk pasien

                            doctorBpmView.style.display = 'none'; // Sembunyikan bagian BPM pasien untuk pasien
                            refreshBpmBtn.style.display = 'inline-block'; // Tampilkan tombol refresh BPM untuk pasien
                            bpmStatusMessage.textContent = 'Data detak jantung terbaru Anda akan ditampilkan di sini.';
                            loadPatientBPM(user.uid); // Muat BPM untuk pasien yang login
                        }
                        // --- Akhir Logika Pengalihan Dashboard ---

                    } else {
                        console.log("No user data found, creating new profile with default role 'patient'.");
                        // Ini akan jarang terjadi jika sign-up sudah menyimpan peran, tapi tetap penting
                        db.collection('users').doc(user.uid).set({
                            email: user.email,
                            name: '',
                            nik: '',
                            placeDob: '',
                            address: '',
                            phone: '',
                            role: 'patient', // Default role jika user tidak ada di Firestore
                            // Tambahkan field untuk BPM agar bisa diupdate
                            bpm: null,
                            lastBpmUpdate: null
                        }, { merge: true }).then(() => {
                            profileNameInput.value = '';
                            profileNikInput.value = '';
                            profilePlaceDobInput.value = '';
                            profileAddressInput.value = '';
                            profilePhoneInput.value = '';
                            userRoleSpan.textContent = 'Pasien';
                            currentUserRole = 'patient';
                            console.log("New user profile created successfully.");
                            showSection(profileSection); // Tampilkan profil section
                            patientListDiv.style.display = 'none'; // Sembunyikan daftar pasien
                            doctorBpmView.style.display = 'none'; // Sembunyikan bagian BPM pasien
                            refreshBpmBtn.style.display = 'inline-block'; // Tampilkan tombol refresh BPM
                            bpmStatusMessage.textContent = 'Data detak jantung terbaru Anda akan ditampilkan di sini.';
                            loadPatientBPM(user.uid); // Muat BPM untuk pasien yang login
                        }).catch(error => {
                            console.error("Error creating new user profile:", error);
                            alert("Gagal membuat profil baru: " + error.message);
                        });
                    }
                }).catch(error => {
                    console.error("Error getting user profile:", error);
                    alert("Gagal memuat profil: " + error.message);
                });

            } else {
                console.log("No user logged in, redirecting to index.html.");
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert('Anda telah berhasil logout.');
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error during logout:", error);
                alert("Gagal logout: " + error.message);
            }
        });

        // Logika Edit dan Simpan Profil
        editProfileBtn.addEventListener('click', () => {
            profileNameInput.disabled = false;
            profileNikInput.disabled = false;
            profilePlaceDobInput.disabled = false;
            profileAddressInput.disabled = false;
            profilePhoneInput.disabled = false;

            editProfileBtn.style.display = 'none';
            saveProfileBtn.style.display = 'inline-block';
        });

        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const userName = profileNameInput.value.trim();
                const userNik = profileNikInput.value.trim();
                const userPlaceDob = profilePlaceDobInput.value.trim();
                const userAddress = profileAddressInput.value.trim();
                const userPhone = profilePhoneInput.value.trim();

                try {
                    await db.collection('users').doc(user.uid).set({
                        name: userName,
                        email: user.email,
                        nik: userNik,
                        placeDob: userPlaceDob,
                        address: userAddress,
                        phone: userPhone,
                        role: currentUserRole // Pastikan peran juga disimpan
                    }, { merge: true });

                    alert('Profil berhasil disimpan!');
                    profileNameInput.disabled = true;
                    profileNikInput.disabled = true;
                    profilePlaceDobInput.disabled = true;
                    profileAddressInput.disabled = true;
                    profilePhoneInput.disabled = true;

                    editProfileBtn.style.display = 'inline-block';
                    saveProfileBtn.style.display = 'none';
                } catch (error) {
                    console.error("Error saving profile:", error);
                    alert("Gagal menyimpan profil: " + error.message);
                }
            } else {
                alert("Anda harus login untuk menyimpan profil.");
            }
        });

        // --- Heart Rate Section (Pasien & Dokter) ---

        // Fungsi untuk memperbarui BPM pasien (simulasi)
        async function updatePatientBPM(userId) {
            try {
                const randomBPM = Math.floor(Math.random() * (100 - 60 + 1)) + 60; // BPM antara 60-100
                await db.collection('users').doc(userId).update({
                    bpm: randomBPM,
                    lastBpmUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
                if (userId === auth.currentUser.uid) { // Hanya update display jika ini BPM user yang login
                    currentBpmDisplay.textContent = `${randomBPM} BPM`;
                    bpmStatusMessage.textContent = `Detak jantung Anda terbaru (${new Date().toLocaleTimeString()}).`;
                }
                console.log(`BPM user ${userId} diperbarui menjadi ${randomBPM}`);
            } catch (error) {
                console.error("Error updating BPM:", error);
                alert("Gagal memperbarui BPM: " + error.message);
            }
        }

        // Fungsi untuk memuat BPM pasien yang sedang login
        function loadPatientBPM(userId) {
            db.collection('users').doc(userId).onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.bpm !== null) {
                        currentBpmDisplay.textContent = `${userData.bpm} BPM`;
                        let lastUpdate = 'Tidak diketahui';
                        if (userData.lastBpmUpdate) {
                            lastUpdate = userData.lastBpmUpdate.toDate().toLocaleTimeString();
                        }
                        bpmStatusMessage.textContent = `Detak jantung Anda terbaru (${lastUpdate}).`;
                    } else {
                        currentBpmDisplay.textContent = `-- BPM`;
                        bpmStatusMessage.textContent = 'Belum ada data detak jantung. Klik "Refresh BPM" untuk simulasi.';
                    }
                }
            }, error => {
                console.error("Error loading patient BPM:", error);
                bpmStatusMessage.textContent = 'Gagal memuat data detak jantung.';
            });
        }

        // Fungsi untuk memuat daftar BPM semua pasien (untuk dokter)
        function loadPatientBPMs() {
            patientBpmList.innerHTML = ''; // Bersihkan daftar sebelumnya
            db.collection('users')
                .where('role', '==', 'patient')
                .onSnapshot(snapshot => {
                    patientBpmList.innerHTML = ''; // Bersihkan lagi untuk update real-time
                    if (snapshot.empty) {
                        patientBpmList.innerHTML = '<li>Belum ada data BPM dari pasien.</li>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const patientData = doc.data();
                        const li = document.createElement('li');
                        const bpmValue = patientData.bpm !== null ? `${patientData.bpm} BPM` : 'N/A';
                        const lastUpdate = patientData.lastBpmUpdate ? patientData.lastBpmUpdate.toDate().toLocaleTimeString() : 'Belum ada data';
                        li.innerHTML = `<strong>${patientData.name || patientData.email}</strong>: <span>${bpmValue}</span> (Update: ${lastUpdate})`;
                        patientBpmList.appendChild(li);
                    });
                }, error => {
                    console.error("Error loading all patient BPMs:", error);
                    patientBpmList.innerHTML = '<li>Gagal memuat data BPM pasien.</li>';
                });
        }


        refreshBpmBtn.addEventListener('click', () => {
            const user = auth.currentUser;
            if (user && currentUserRole === 'patient') {
                updatePatientBPM(user.uid);
            } else {
                alert("Tombol ini untuk pasien untuk memperbarui BPM mereka (simulasi).");
            }
        });


        // --- Education Section ---
        const articles = [
            {
                title: "Apa itu Aritmia? Pelajari Lebih Lanjut tentang Jenis dan Penyebabnya",
                content: "Aritmia adalah kondisi di mana detak jantung tidak teratur, terlalu cepat, atau terlalu lambat. Ini terjadi ketika impuls listrik yang mengoordinasikan detak jantung tidak berfungsi dengan baik. Ada berbagai jenis aritmia, termasuk fibrilasi atrium, takikardia, dan bradikardia. Penyebabnya bisa bervariasi, mulai dari penyakit jantung, tekanan darah tinggi, stres, hingga konsumsi kafein atau alkohol berlebihan. Penting untuk mengenali gejala seperti pusing, pingsan, atau nyeri dada dan segera mencari pertolongan medis.",
                link: "https://www.halodoc.com/kesehatan/aritmia" // Contoh link eksternal
            },
            {
                title: "Tips Gaya Hidup Sehat untuk Jantung Optimal",
                content: "Menjaga kesehatan jantung adalah kunci untuk hidup yang panjang dan berkualitas. Beberapa tips gaya hidup sehat meliputi: 1. Diet seimbang: Konsumsi buah, sayur, biji-bijian, dan protein tanpa lemak. Hindari makanan olahan, tinggi gula, dan lemak jenuh. 2. Olahraga teratur: Lakukan aktivitas fisik moderat setidaknya 150 menit per minggu. 3. Kelola stres: Cari cara sehat untuk mengatasi stres, seperti meditasi, yoga, atau hobi. 4. Tidur cukup: Pastikan Anda mendapatkan 7-9 jam tidur berkualitas setiap malam. 5. Hindari merokok dan batasi alkohol.",
                link: "https://www.alodokter.com/gaya-hidup-sehat-untuk-menjaga-kesehatan-jantung"
            },
            {
                title: "Pentingnya Olahraga Teratur dan Nutrisi Seimbang",
                content: "Olahraga teratur memperkuat otot jantung, meningkatkan sirkulasi darah, dan membantu menjaga berat badan ideal. Nutrisi seimbang menyediakan energi dan nutrisi penting yang dibutuhkan jantung untuk berfungsi optimal. Kombinasi keduanya secara signifikan mengurangi risiko penyakit jantung.",
                link: "https://www.mayoclinic.org/diseases-conditions/heart-disease/in-depth/heart-healthy-diet/art-20047702"
            },
            {
                title: "Panduan Pertolongan Pertama untuk Serangan Jantung",
                content: "Mengenali gejala serangan jantung dan mengetahui pertolongan pertama dapat menyelamatkan nyawa. Gejala umum meliputi nyeri dada yang menjalar ke lengan, leher, rahang, atau punggung, sesak napas, keringat dingin, mual, dan pusing. Jika Anda atau seseorang di sekitar Anda mengalami gejala ini: 1. Segera hubungi layanan darurat (misalnya, 112 atau 911). 2. Bantu orang tersebut duduk dengan nyaman. 3. Jika orang tersebut sadar dan tidak alergi, berikan tablet aspirin untuk dikunyah (jika tersedia dan sesuai). 4. Longgarkan pakaian yang ketat. 5. Tetap tenang dan tunggu bantuan medis datang.",
                link: "https://www.who.int/news-room/fact-sheets/detail/cardiovascular-diseases-(cvds)"
            }
        ];

        function loadEducationArticles() {
            articleList.innerHTML = '';
            articles.forEach(article => {
                const li = document.createElement('li');
                const h4 = document.createElement('h4');
                const p = document.createElement('p');
                const a = document.createElement('a');

                h4.textContent = article.title;
                p.textContent = article.content;
                a.href = article.link;
                a.textContent = 'Baca Selengkapnya';
                a.target = '_blank'; // Buka di tab baru
                a.classList.add('article-link');

                li.appendChild(h4);
                li.appendChild(p);
                li.appendChild(a); // Tambahkan link
                articleList.appendChild(li);
            });
        }

        // --- Chat Section ---

        // Unsubscribe function for real-time listener
        let unsubscribeChatListener = null;

        function displayMessage(message, currentUserId) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            // Determine message sender role for styling
            if (message.senderId === currentUserId) {
                messageDiv.classList.add('user'); // Pesan dari user yang sedang login (baik pasien/dokter)
                messageDiv.textContent = message.text;
            } else if (message.senderRole === 'doctor') {
                messageDiv.classList.add('doctor-reply'); // Pesan dari dokter (untuk pasien)
                messageDiv.innerHTML = `<strong>Dokter ${message.senderName || message.senderEmail}:</strong> ${message.text}`;
            } else if (message.senderRole === 'patient') {
                messageDiv.classList.add('patient-other'); // Pesan dari pasien lain (untuk tampilan dokter)
                messageDiv.innerHTML = `<strong>Pasien ${message.senderName || message.senderEmail}:</strong> ${message.text}`;
            }
            chatMessagesDiv.appendChild(messageDiv);
        }

        async function sendMessage() {
            const messageText = chatMessageInput.value.trim();
            const user = auth.currentUser;

            if (!messageText || !user) {
                return;
            }

            const userName = profileNameInput.value.trim() || user.email;
            const userRole = currentUserRole;

            try {
                let chatData = {
                    senderId: user.uid,
                    senderRole: userRole,
                    senderEmail: user.email,
                    senderName: userName,
                    text: messageText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Untuk pasien, originalPatientId adalah UID mereka sendiri
                    // Untuk dokter, originalPatientId adalah UID pasien yang sedang mereka balas (selectedPatientIdForDoctor)
                    originalPatientId: userRole === 'patient' ? user.uid : (selectedPatientIdForDoctor)
                };

                // Validasi tambahan untuk dokter: harus memilih pasien
                if (userRole === 'doctor' && !selectedPatientIdForDoctor) {
                    alert('Dokter harus memilih pasien dari daftar untuk memulai atau melanjutkan chat.');
                    return;
                }

                await db.collection('chats').add(chatData);
                chatMessageInput.value = '';
                // Scroll akan otomatis jika onSnapshot terpicu
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Gagal mengirim pesan: " + error.message);
            }
        }

        sendChatBtn.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });


        // Fungsi untuk memuat pesan chat yang spesifik (dipanggil oleh pasien atau dokter setelah memilih pasien)
        function loadSpecificChat(targetPatientId, targetPatientName) {
            // Hentikan listener sebelumnya jika ada
            if (unsubscribeChatListener) {
                unsubscribeChatListener();
                console.log("Previous chat listener unsubscribed.");
            }

            chatMessagesDiv.innerHTML = `<h4 class="chat-with-patient-title">Chat dengan ${targetPatientName || 'Pasien'}</h4>`; // Kosongkan chat dan beri judul
            selectedPatientIdForDoctor = targetPatientId; // Update ID pasien yang dipilih

            unsubscribeChatListener = db.collection('chats')
                .where('originalPatientId', '==', targetPatientId)
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    chatMessagesDiv.innerHTML = `<h4 class="chat-with-patient-title">Chat dengan ${targetPatientName || 'Pasien'}</h4>`; // Kosongkan lagi untuk update real-time
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        displayMessage(message, auth.currentUser.uid); // Pass current user's UID for styling
                    });
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }, error => {
                    console.error("Error loading specific chat messages:", error);
                    chatMessagesDiv.innerHTML = `<p style="text-align: center; color: red;">Gagal memuat chat.</p>`;
                });
        }


        // Fungsi untuk memuat daftar pasien untuk dokter
        function loadPatientListForChat() {
            patientListDiv.innerHTML = '<h4>Daftar Chat Pasien:</h4>';
            // Dapatkan semua pasien yang pernah mengirim pesan
            db.collection('chats')
                .where('senderRole', '==', 'patient')
                .get() // Menggunakan get() untuk daftar pasien, bukan onSnapshot
                .then(snapshot => {
                    const uniquePatients = new Map();
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        if (message.originalPatientId && !uniquePatients.has(message.originalPatientId)) {
                            uniquePatients.set(message.originalPatientId, {
                                id: message.originalPatientId,
                                name: message.senderName,
                                email: message.senderEmail
                            });
                        }
                    });

                    if (uniquePatients.size === 0) {
                        patientListDiv.innerHTML = '<p>Belum ada pasien yang memulai chat.</p>';
                        // Sembunyikan input chat jika tidak ada pasien
                        chatMessageInput.disabled = true;
                        sendChatBtn.disabled = true;
                    } else {
                        uniquePatients.forEach(patient => {
                            const patientButton = document.createElement('button');
                            patientButton.textContent = `Chat dengan ${patient.name || patient.email}`;
                            patientButton.dataset.patientId = patient.id;
                            patientButton.dataset.patientName = patient.name || patient.email; // Simpan nama untuk judul

                            patientButton.addEventListener('click', function() {
                                // Hapus highlight dari semua tombol pasien
                                document.querySelectorAll('#patient-list-container button').forEach(btn => {
                                    btn.classList.remove('active-patient');
                                });
                                // Tambahkan highlight ke tombol yang sedang diklik
                                this.classList.add('active-patient');

                                selectedPatientIdForDoctor = patient.id; // Set ID pasien yang dipilih
                                selectedPatientNameForDoctor = patient.name || patient.email; // Set nama pasien yang dipilih

                                // Aktifkan input chat
                                chatMessageInput.disabled = false;
                                sendChatBtn.disabled = false;

                                // Muat chat spesifik pasien ini
                                loadSpecificChat(selectedPatientIdForDoctor, selectedPatientNameForDoctor);
                            });
                            patientListDiv.appendChild(patientButton);
                        });
                        // Pada awalnya, chat input dinonaktifkan sampai dokter memilih pasien
                        chatMessageInput.disabled = true;
                        sendChatBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error("Error loading patient list for chat:", error);
                    patientListDiv.innerHTML = '<p>Gagal memuat daftar pasien.</p>';
                });
        }


        // --- Inisialisasi Saat Halaman Dimuat ---
        document.addEventListener('DOMContentLoaded', () => {
            loadEducationArticles(); // Muat artikel edukasi

            navProfileBtn.addEventListener('click', () => showSection(profileSection));
            navHeartRateBtn.addEventListener('click', () => showSection(heartRateSection));
            navEducationBtn.addEventListener('click', () => showSection(educationSection));
            navChatBtn.addEventListener('click', () => {
                showSection(chatSection);
                if (currentUserRole === 'doctor') {
                    // Jika dokter mengklik tab chat, muat ulang daftar pasien jika belum ada yang dipilih
                    if (!selectedPatientIdForDoctor) {
                        loadPatientListForChat();
                        chatMessagesDiv.innerHTML = '<h3>Pilih pasien dari daftar di atas untuk melihat chat.</h3>'; // Pesan awal untuk dokter
                    }
                } else {
                    // Pasien selalu langsung memuat chat mereka sendiri
                    // Perlu memastikan user.uid tersedia, ini akan aman karena onAuthStateChanged sudah memeriksa user
                    // Perlu juga nama user untuk judul chat
                    if (auth.currentUser) {
                        loadSpecificChat(auth.currentUser.uid, profileNameInput.value.trim() || 'Anda');
                    } else {
                        chatMessagesDiv.innerHTML = '<h3>Harap login untuk menggunakan fitur chat.</h3>';
                    }
                }
            });
        });
    </script>
</body>
</html>
