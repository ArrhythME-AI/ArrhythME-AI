<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ArrhythME-AI</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #ca7e7e;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 800px;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #a00e0e;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
        }
        .user-info {
            font-weight: bold;
            color: #a00e0e;
        }

        .dashboard-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
        }
        .dashboard-nav button {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 12px 20px;
            background: #a00e0e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .dashboard-nav button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }
        .dashboard-nav button.active {
            background: #a00e0e;
            box-shadow: 0 0 0 3px rgba(144, 11, 11, 0.4);
        }

        .dashboard-content {
            background: white;
            width: 100%;
            max-width: 800px;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: left;
            margin-top: 20px;
            min-height: 300px;
        }
        .dashboard-content h3 {
            color: #a00e0e;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        #profile-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        #profile-section input[type="text"],
        #profile-section input[type="email"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        #profile-section button {
            background: #a00e0e;
            margin-top: 10px;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #profile-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        #heart-rate-section .heart-rate-display {
            font-size: 4em;
            font-weight: bold;
            color: #e53935;
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        #heart-rate-section p {
            text-align: center;
        }
        #heart-rate-section button {
            background: #a00e0e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }
        #heart-rate-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        #education-section ul {
            list-style: none;
            padding: 0;
        }

        #education-section li {
            background-color: #f5f5f5;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        #education-section li:hover {
            transform: translateY(-3px);
        }

        #education-section h4 {
            color: #a00e0e;
            margin-bottom: 5px;
            font-size: 1.3em;
        }

        #education-section p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.5;
            text-align: left;
        }
        /* Tambahan untuk link artikel */
        #education-section .article-link {
            display: block;
            margin-top: 10px;
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        #education-section .article-link:hover {
            text-decoration: underline;
        }

        #education-section button {
            margin-top: 20px;
            width: 100%;
            background: #a00e0e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #education-section button:hover {
            background: #8e0c0c;
            transform: translateY(-2px);
        }

        /* Chat Section Styling */
        #chat-section .chat-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
        }
        #chat-section .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
        }
        #chat-section .message.user { /* Pesan dari user yang sedang login (baik pasien/dokter) */
            background-color: #e1ffc7;
            align-self: flex-end;
            margin-left: auto;
        }
        #chat-section .message.doctor { /* Pesan dari dokter lain (untuk pasien) atau dari diri sendiri (untuk dokter) */
            background-color: #d1e7dd;
            align-self: flex-start;
            margin-right: auto;
        }
        #chat-section .message.patient-other { /* Pesan dari pasien lain (untuk tampilan dokter) */
            background-color: #f0f8ff;
            align-self: flex-start;
            margin-right: auto;
        }
        #chat-section .chat-input {
            display: flex;
            gap: 10px;
        }
        #chat-section .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        #chat-section .chat-input button {
            padding: 10px 15px;
            margin-top: 0;
            background: #a00e0e;
            color: white;
            border-radius: 5px;
            font-size: 1em;
        }
        #chat-section .chat-input button:hover {
            background: #8e0c0c;
        }
        /* Styling untuk daftar pasien (khusus dokter) */
        #patient-list-container {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 180px; /* Batasi tinggi untuk scroll */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background-color: #fcfcfc;
        }

        #patient-list-container h4 {
            color: #a00e0e;
            margin-bottom: 15px;
            text-align: center;
        }

        #patient-list-container button {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #patient-list-container button:hover {
            background-color: #e0e0e0;
            border-color: #c0c0c0;
        }
        #patient-list-container button.active-patient {
            background-color: #d1e7dd; /* Highlight the selected patient */
            border-color: #a0c2a0;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Selamat Datang di Dashboard ArrhythME-AI!</h1>
        <p>Anda telah berhasil masuk.</p>
        <p>Email Anda: <span id="user-email" class="user-info">Memuat...</span></p>
        <p>Peran Anda: <span id="user-role" class="user-info">Memuat...</span></p>

        <p>Di sini Anda dapat memantau detak jantung, melihat riwayat analisis, dan mengelola pengaturan.</p>
        <p>Fitur-fitur canggih akan segera hadir!</p>

        <div class="dashboard-nav">
            <button id="nav-profile" class="active">Profil</button>
            <button id="nav-heart-rate">Detak Jantung (BPM)</button>
            <button id="nav-education">Edukasi</button>
            <button id="nav-chat">Chat dengan Dokter</button>
            <button id="logout-btn">Logout</button>
        </div>
    </div>

    <div class="dashboard-content">
        <div id="profile-section" class="content-section">
            <h3>Profil Pengguna</h3>
            <label for="profile-name">Nama:</label>
            <input type="text" id="profile-name" placeholder="Masukkan Nama Lengkap" disabled>
            <label for="profile-email">Email:</label>
            <input type="email" id="profile-email" value="user@example.com" disabled>
            <label for="profile-nik">NIK:</label>
            <input type="text" id="profile-nik" placeholder="Masukkan NIK Anda" disabled>
            <label for="profile-place-dob">Tempat, Tanggal Lahir:</label>
            <input type="text" id="profile-place-dob" placeholder="Contoh: Jakarta, 01/01/1990" disabled>
            <label for="profile-address">Alamat:</label>
            <input type="text" id="profile-address" placeholder="Masukkan Alamat Lengkap" disabled>
            <label for="profile-phone">Nomor Telepon:</label>
            <input type="text" id="profile-phone" placeholder="Masukkan Nomor Telepon" disabled>
            <button id="edit-profile-btn">Edit Profil</button>
            <button id="save-profile-btn" style="display: none;">Simpan Profil</button>
        </div>

        <div id="heart-rate-section" class="content-section" style="display: none;">
            <h3>Detak Jantung Anda (BPM)</h3>
            <div class="heart-rate-display">-- BPM</div>
            <p>Data detak jantung terbaru Anda akan ditampilkan di sini.</p>
            <p>Fitur monitoring real-time akan segera tersedia.</p>
            <button>Refresh BPM</button>
        </div>

        <div id="education-section" class="content-section" style="display: none;">
            <h3>Pusat Edukasi Kesehatan Jantung</h3>
            <p>Dapatkan informasi terbaru mengenai kesehatan jantung, pencegahan, dan gaya hidup sehat.</p>
            <ul id="article-list">
                </ul>
            <button>Lihat Artikel Selengkapnya</button>
        </div>

        <div id="chat-section" class="content-section" style="display: none;">
            <h3>Chat dengan Dokter</h3>
            <div class="chat-box" id="chat-messages">
                </div>
            <div class="chat-input">
                <input type="text" id="chat-message-input" placeholder="Ketik pesan Anda...">
                <button id="send-chat-btn">Kirim</button>
            </div>
            <p style="font-size: 0.9em; color: #888; text-align: center; margin-top: 15px;">
                *Layanan ini untuk konsultasi awal. Untuk diagnosis, segera temui dokter.
            </p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        // Konfigurasi Firebase Anda (HARUS SESUAI DENGAN PROYEK FIREBASE ANDA)
        const firebaseConfig = {
           apiKey: "AIzaSyD8ROGRR-CvDaD3THjpFagbt-I0jFPoTEk",
             authDomain: "arrhythme-ai-29cc8.firebaseapp.com",
             databaseURL: "https://arrhythme-ai-29cc8-default-rtdb.firebaseio.com",
             projectId: "arrhythme-ai-29cc8",
             storageBucket: "arrhythme-ai-29cc8.firebasestorage.app",
             messagingSenderId: "869423405995",
             appId: "1:869423405995:web:d750c0530b9709029190ee",
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Dapatkan elemen DOM
        const userEmailSpan = document.getElementById('user-email');
        const userRoleSpan = document.getElementById('user-role');
        const logoutBtn = document.getElementById('logout-btn');

        // Navigasi
        const navProfileBtn = document.getElementById('nav-profile');
        const navHeartRateBtn = document.getElementById('nav-heart-rate');
        const navEducationBtn = document.getElementById('nav-education');
        const navChatBtn = document.getElementById('nav-chat');

        // Bagian Konten
        const profileSection = document.getElementById('profile-section');
        const heartRateSection = document.getElementById('heart-rate-section');
        const educationSection = document.getElementById('education-section');
        const chatSection = document.getElementById('chat-section');

        // Elemen Profil
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const profileNikInput = document.getElementById('profile-nik');
        const profilePlaceDobInput = document.getElementById('profile-place-dob');
        const profileAddressInput = document.getElementById('profile-address');
        const profilePhoneInput = document.getElementById('profile-phone');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        // Elemen Edukasi
        const articleList = document.getElementById('article-list');

        // Elemen Chat
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // Variabel global untuk peran dan chat dokter
        let currentUserRole = 'patient'; // Default role (akan di-overwrite dari Firestore)
        let selectedPatientIdForDoctor = null; // UID pasien yang sedang dilihat/dibalas dokter

        // Div untuk daftar pasien (hanya untuk dokter)
        const patientListDiv = document.createElement('div');
        patientListDiv.id = 'patient-list-container';
        chatSection.insertBefore(patientListDiv, chatMessagesDiv); // Sisipkan di awal chatSection

        // --- Fungsi Utama ---

        function showSection(sectionToShow) {
            const sections = [profileSection, heartRateSection, educationSection, chatSection];
            sections.forEach(section => {
                if (section === sectionToShow) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });

            const navButtons = document.querySelectorAll('.dashboard-nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            if (sectionToShow === profileSection) navProfileBtn.classList.add('active');
            else if (sectionToShow === heartRateSection) navHeartRateBtn.classList.add('active');
            else if (sectionToShow === educationSection) navEducationBtn.classList.add('active');
            else if (sectionToShow === chatSection) navChatBtn.classList.add('active');
        }

        // --- Firebase Auth & Profile Management ---

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User logged in:", user.email);
                userEmailSpan.textContent = user.email;
                profileEmailInput.value = user.email;

                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        console.log("User data loaded:", userData);
                        profileNameInput.value = userData.name || '';
                        profileNikInput.value = userData.nik || '';
                        profilePlaceDobInput.value = userData.placeDob || '';
                        profileAddressInput.value = userData.address || '';
                        profilePhoneInput.value = userData.phone || '';
                        currentUserRole = userData.role || 'patient'; // Pastikan role terbaca
                        userRoleSpan.textContent = currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1);

                        // --- Logika Pengalihan Dashboard Berdasarkan Peran ---
                        if (currentUserRole === 'doctor') {
                            showSection(chatSection); // Jika dokter, langsung ke Chat
                            // Sembunyikan navigasi yang tidak relevan untuk dokter
                            navProfileBtn.style.display = 'none';
                            navHeartRateBtn.style.display = 'none';
                            navEducationBtn.style.display = 'none';
                            navChatBtn.classList.add('active'); // Pastikan tombol chat aktif
                            patientListDiv.style.display = 'block'; // Tampilkan daftar pasien untuk dokter

                        } else { // Jika pasien
                            showSection(profileSection); // Default ke Profil untuk pasien
                            // Pastikan semua tombol navigasi pasien ditampilkan
                            navProfileBtn.style.display = 'inline-block';
                            navHeartRateBtn.style.display = 'inline-block';
                            navEducationBtn.style.display = 'inline-block';
                            navChatBtn.style.display = 'inline-block';
                            patientListDiv.style.display = 'none'; // Sembunyikan daftar pasien untuk pasien
                        }
                        // --- Akhir Logika Pengalihan Dashboard ---

                    } else {
                        console.log("No user data found, creating new profile with default role 'patient'.");
                        // Ini akan jarang terjadi jika sign-up sudah menyimpan peran, tapi tetap penting
                        db.collection('users').doc(user.uid).set({
                            email: user.email,
                            name: '',
                            nik: '',
                            placeDob: '',
                            address: '',
                            phone: '',
                            role: 'patient' // Default role jika user tidak ada di Firestore
                        }, { merge: true }).then(() => {
                            profileNameInput.value = '';
                            profileNikInput.value = '';
                            profilePlaceDobInput.value = '';
                            profileAddressInput.value = '';
                            profilePhoneInput.value = '';
                            userRoleSpan.textContent = 'Patient';
                            currentUserRole = 'patient';
                            console.log("New user profile created successfully.");
                            showSection(profileSection); // Tampilkan profil section
                            patientListDiv.style.display = 'none'; // Sembunyikan daftar pasien
                        }).catch(error => {
                            console.error("Error creating new user profile:", error);
                            alert("Gagal membuat profil baru: " + error.message);
                        });
                    }
                    loadChatMessages(); // Selalu panggil ini untuk memuat pesan
                }).catch(error => {
                    console.error("Error getting user profile:", error);
                    alert("Gagal memuat profil: " + error.message);
                });

            } else {
                console.log("No user logged in, redirecting to index.html.");
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert('Anda telah berhasil logout.');
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error during logout:", error);
                alert("Gagal logout: " + error.message);
            }
        });

        // Logika Edit dan Simpan Profil
        editProfileBtn.addEventListener('click', () => {
            profileNameInput.disabled = false;
            profileNikInput.disabled = false;
            profilePlaceDobInput.disabled = false;
            profileAddressInput.disabled = false;
            profilePhoneInput.disabled = false;

            editProfileBtn.style.display = 'none';
            saveProfileBtn.style.display = 'inline-block';
        });

        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const userName = profileNameInput.value.trim();
                const userNik = profileNikInput.value.trim();
                const userPlaceDob = profilePlaceDobInput.value.trim();
                const userAddress = profileAddressInput.value.trim();
                const userPhone = profilePhoneInput.value.trim();

                try {
                    await db.collection('users').doc(user.uid).set({
                        name: userName,
                        email: user.email,
                        nik: userNik,
                        placeDob: userPlaceDob,
                        address: userAddress,
                        phone: userPhone,
                        role: currentUserRole // Pastikan peran juga disimpan
                    }, { merge: true });

                    alert('Profil berhasil disimpan!');
                    profileNameInput.disabled = true;
                    profileNikInput.disabled = true;
                    profilePlaceDobInput.disabled = true;
                    profileAddressInput.disabled = true;
                    profilePhoneInput.disabled = true;

                    editProfileBtn.style.display = 'inline-block';
                    saveProfileBtn.style.display = 'none';
                } catch (error) {
                    console.error("Error saving profile:", error);
                    alert("Gagal menyimpan profil: " + error.message);
                }
            } else {
                alert("Anda harus login untuk menyimpan profil.");
            }
        });

        // --- Education Section ---
        const articles = [
            {
                title: "Apa itu Aritmia? Pelajari Lebih Lanjut tentang Jenis dan Penyebabnya",
                content: "Aritmia adalah kondisi di mana detak jantung tidak teratur, terlalu cepat, atau terlalu lambat. Ini terjadi ketika impuls listrik yang mengoordinasikan detak jantung tidak berfungsi dengan baik. Ada berbagai jenis aritmia, termasuk fibrilasi atrium, takikardia, dan bradikardia. Penyebabnya bisa bervariasi, mulai dari penyakit jantung, tekanan darah tinggi, stres, hingga konsumsi kafein atau alkohol berlebihan. Penting untuk mengenali gejala seperti pusing, pingsan, atau nyeri dada dan segera mencari pertolongan medis.",
                link: "https://www.halodoc.com/kesehatan/aritmia" // Contoh link eksternal
            },
            {
                title: "Tips Gaya Hidup Sehat untuk Jantung Optimal",
                content: "Menjaga kesehatan jantung adalah kunci untuk hidup yang panjang dan berkualitas. Beberapa tips gaya hidup sehat meliputi: 1. Diet seimbang: Konsumsi buah, sayur, biji-bijian, dan protein tanpa lemak. Hindari makanan olahan, tinggi gula, dan lemak jenuh. 2. Olahraga teratur: Lakukan aktivitas fisik moderat setidaknya 150 menit per minggu. 3. Kelola stres: Cari cara sehat untuk mengatasi stres, seperti meditasi, yoga, atau hobi. 4. Tidur cukup: Pastikan Anda mendapatkan 7-9 jam tidur berkualitas setiap malam. 5. Hindari merokok dan batasi alkohol.",
                link: "https://www.alodokter.com/gaya-hidup-sehat-untuk-menjaga-kesehatan-jantung"
            },
            {
                title: "Pentingnya Olahraga Teratur dan Nutrisi Seimbang",
                content: "Olahraga teratur memperkuat otot jantung, meningkatkan sirkulasi darah, dan membantu menjaga berat badan ideal. Nutrisi seimbang menyediakan energi dan nutrisi penting yang dibutuhkan jantung untuk berfungsi optimal. Kombinasi keduanya secara signifikan mengurangi risiko penyakit jantung.",
                link: "https://www.mayoclinic.org/diseases-conditions/heart-disease/in-depth/heart-healthy-diet/art-20047702"
            },
            {
                title: "Panduan Pertolongan Pertama untuk Serangan Jantung",
                content: "Mengenali gejala serangan jantung dan mengetahui pertolongan pertama dapat menyelamatkan nyawa. Gejala umum meliputi nyeri dada yang menjalar ke lengan, leher, rahang, atau punggung, sesak napas, keringat dingin, mual, dan pusing. Jika Anda atau seseorang di sekitar Anda mengalami gejala ini: 1. Segera hubungi layanan darurat (misalnya, 112 atau 911). 2. Bantu orang tersebut duduk dengan nyaman. 3. Jika orang tersebut sadar dan tidak alergi, berikan tablet aspirin untuk dikunyah (jika tersedia dan sesuai). 4. Longgarkan pakaian yang ketat. 5. Tetap tenang dan tunggu bantuan medis datang.",
                link: "https://www.who.int/news-room/fact-sheets/detail/cardiovascular-diseases-(cvds)"
            }
        ];

        function loadEducationArticles() {
            articleList.innerHTML = '';
            articles.forEach(article => {
                const li = document.createElement('li');
                const h4 = document.createElement('h4');
                const p = document.createElement('p');
                const a = document.createElement('a');

                h4.textContent = article.title;
                p.textContent = article.content;
                a.href = article.link;
                a.textContent = 'Baca Selengkapnya';
                a.target = '_blank'; // Buka di tab baru
                a.classList.add('article-link');

                li.appendChild(h4);
                li.appendChild(p);
                li.appendChild(a); // Tambahkan link
                articleList.appendChild(li);
            });
        }

        // --- Chat Section ---

        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (auth.currentUser && message.senderId === auth.currentUser.uid) {
                messageDiv.classList.add('user'); // Pesan dari user yang sedang login
                messageDiv.textContent = message.text;
            } else {
                if (message.senderRole === 'doctor') {
                    messageDiv.classList.add('doctor'); // Pesan dari dokter lain (untuk pasien)
                    messageDiv.innerHTML = `<strong>Dokter ${message.senderName || message.senderEmail}:</strong> ${message.text}`;
                } else {
                    messageDiv.classList.add('patient-other'); // Pesan dari pasien lain (untuk tampilan dokter)
                    messageDiv.innerHTML = `<strong>Pasien ${message.senderName || message.senderEmail}:</strong> ${message.text}`;
                }
            }
            chatMessagesDiv.appendChild(messageDiv);
        }

        async function sendMessage() {
            const messageText = chatMessageInput.value.trim();
            const user = auth.currentUser;

            if (!messageText || !user) {
                return;
            }

            const userName = profileNameInput.value.trim() || user.email;
            const userRole = currentUserRole;

            try {
                let chatData = {
                    senderId: user.uid,
                    senderRole: userRole,
                    senderEmail: user.email,
                    senderName: userName,
                    text: messageText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: userRole === 'patient' ? 'general_consultation' : 'doctor_reply',
                    // Untuk pasien, originalPatientId adalah UID mereka sendiri
                    // Untuk dokter, originalPatientId adalah UID pasien yang sedang mereka balas (selectedPatientIdForDoctor)
                    // Jika dokter belum memilih pasien, originalPatientId akan menjadi UID dokter itu sendiri (fallback)
                    originalPatientId: userRole === 'patient' ? user.uid : (selectedPatientIdForDoctor || user.uid)
                };

                await db.collection('chats').add(chatData);
                chatMessageInput.value = '';
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

                // Jika dokter mengirim pesan, dan belum ada pasien terpilih,
                // mungkin perlu me-refresh daftar pasien atau menandai chat ini.
                // Untuk kesederhanaan, ini akan ditangani oleh loadChatMessages berikutnya.

            } catch (error) {
                console.error("Error sending message:", error);
                alert("Gagal mengirim pesan: " + error.message);
            }
        }

        sendChatBtn.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function loadChatMessages() {
            chatMessagesDiv.innerHTML = ''; // Kosongkan chat sebelumnya
            patientListDiv.innerHTML = ''; // Kosongkan daftar pasien

            if (currentUserRole === 'patient') {
                patientListDiv.style.display = 'none'; // Sembunyikan daftar pasien untuk pasien
                // Pasien hanya melihat pesan yang `originalPatientId`-nya adalah UID mereka
                db.collection('chats')
                    .where('originalPatientId', '==', auth.currentUser.uid)
                    .orderBy('timestamp')
                    .onSnapshot(snapshot => {
                        chatMessagesDiv.innerHTML = ''; // Kosongkan lagi untuk update real-time
                        snapshot.forEach(doc => {
                            const message = doc.data();
                            displayMessage(message);
                        });
                        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                    }, error => {
                        console.error("Error loading patient's chat messages:", error);
                    });

            } else if (currentUserRole === 'doctor') {
                patientListDiv.style.display = 'block';
                chatMessagesDiv.innerHTML = '<h3>Pilih pasien dari daftar di atas untuk melihat chat.</h3>'; // Pesan awal untuk dokter

                // Dokter akan melihat semua pasien yang sudah mengirim pesan
                db.collection('chats')
                    .where('senderRole', '==', 'patient') // Hanya ambil pesan yang dikirim pasien
                    .orderBy('timestamp', 'desc') // Ambil yang terbaru dulu
                    .get() // Gunakan get() sekali untuk mendapatkan daftar pasien unik
                    .then(snapshot => {
                        const patients = new Map(); // Menggunakan Map untuk menyimpan pasien unik
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            // Jika pesan ini bukan dari dokter itu sendiri dan punya originalPatientId
                            if (msg.senderRole === 'patient' && msg.originalPatientId) {
                                patients.set(msg.originalPatientId, {
                                    id: msg.originalPatientId,
                                    name: msg.senderName,
                                    email: msg.senderEmail
                                });
                            }
                        });

                        if (patients.size === 0) {
                            patientListDiv.innerHTML = '<p>Belum ada pasien yang memulai chat.</p>';
                        } else {
                            patientListDiv.innerHTML = '<h4>Daftar Chat Pasien:</h4>';
                            patients.forEach(patient => {
                                const patientButton = document.createElement('button');
                                patientButton.textContent = `Chat dengan ${patient.name || patient.email}`;
                                patientButton.dataset.patientId = patient.id; // Simpan UID pasien di data-attribute

                                patientButton.addEventListener('click', () => {
                                    selectedPatientIdForDoctor = patient.id;
                                    // Hapus highlight dari semua tombol pasien
                                    document.querySelectorAll('#patient-list-container button').forEach(btn => {
                                        btn.classList.remove('active-patient');
                                    });
                                    // Tambahkan highlight ke tombol yang sedang diklik
                                    patientButton.classList.add('active-patient');

                                    // Mulai mendengarkan pesan hanya untuk pasien yang dipilih
                                    db.collection('chats')
                                        .where('originalPatientId', '==', selectedPatientIdForDoctor)
                                        .orderBy('timestamp')
                                        .onSnapshot(snapshot => {
                                            chatMessagesDiv.innerHTML = `<h4 style="text-align: center;">Chat dengan ${patient.name || patient.email}</h4>`;
                                            snapshot.forEach(doc => {
                                                const message = doc.data();
                                                displayMessage(message);
                                            });
                                            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                                        }, error => {
                                            console.error("Error loading specific patient chat messages:", error);
                                        });
                                });
                                patientListDiv.appendChild(patientButton);
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error getting patient list for doctor:", error);
                    });
            }
        }


        // --- Inisialisasi Saat Halaman Dimuat ---
        document.addEventListener('DOMContentLoaded', () => {
            // Peran akan ditentukan oleh auth.onAuthStateChanged, yang akan memanggil showSection
            // jadi tidak perlu panggil showSection(profileSection) secara langsung di sini.
            loadEducationArticles(); // Muat artikel edukasi

            navProfileBtn.addEventListener('click', () => showSection(profileSection));
            navHeartRateBtn.addEventListener('click', () => showSection(heartRateSection));
            navEducationBtn.addEventListener('click', () => showSection(educationSection));
            navChatBtn.addEventListener('click', () => showSection(chatSection));
        });
    </script>
</body>
</html>
